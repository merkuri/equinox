<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta charset="UTF-8" />
  <title>3D Equinox Simulation (Ellipse Trail, Smaller Sun Label, Friendly Font)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: #000;
    }
    .controls {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.5);
      padding: 10px;
      border-radius: 5px;
      z-index: 10;
      font-family: Arial, sans-serif;
      font-size: 18px;
    }
    button {
      margin: 5px;
      padding: 12px 16px;
      font-size: 1.1rem;
      cursor: pointer;
      font-family: inherit;
    }
    #dayDateCaption {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.5);
      color: #fff;
      padding: 8px 12px;
      border-radius: 5px;
      font-size: 16px;
      font-family: Arial, sans-serif;
      z-index: 10;
    }
    #equinoxCaption {
      position: absolute;
      top: 40%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 48px;
      color: magenta;
      text-shadow: 2px 2px 4px #000;
      display: none;
      z-index: 11;
      font-family: Arial, sans-serif;
    }
    #signature {
      position: absolute;
      bottom: 5px;
      right: 5px;
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      font-size: 14px;
      padding: 8px 12px;
      border-radius: 5px;
      z-index: 10;
      font-family: Arial, sans-serif;
    }
  </style>
</head>
<body>
  <div class="controls">
    <button id="pauseResume">Pause</button>
    <button id="stepWeek">Step (1 week)</button>
    <button id="increaseSpeed">Faster</button>
    <button id="decreaseSpeed">Slower</button>
    <button id="toggleLang">ðŸ‡¬ðŸ‡§</button>
  </div>
  <div id="dayDateCaption"></div>
  <div id="equinoxCaption"></div>
  <div id="signature">
    Merkur Beqiri, Mar 20th 2025 â€“ <em>Equinox simulation in JS</em> â€“ merkur@gmail.com
  </div>

  <script>
    let scene, camera, renderer, controls;
    let sunMesh, sunLabel, earthGroup, equatorRing, nsLine, nLabel, sLabel, sunRay;
    let ellipseLine; // for ellipse trail
    let isPaused = false;
    let isEquinoxPause = false;
    let lastEquinoxTriggered = -999;
    let day = 0;
    let speed = 0.5;

    // Elliptical orbit parameters
    const a = 15;        // semi-major axis
    const e = 0.02;      // eccentricity
    // day=172 => aphelion => E=pi

    // Reversed sign tilt
    const maxTilt = 23.5 * Math.PI / 180;

    // Equinox days
    const eqSpring = 80;
    const eqAutumn = 263;

    // Start in Albanian
    let currentLang = 'al';

    // Month data
    const monthDays = [31,28,31,30,31,30,31,31,30,31,30,31];
    const monthNames_en = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    const monthNames_al = ["Jan","Shk","Mar","Pri","Maj","Qer","Kor","Gus","Sht","Tet","NÃ«n","Dhj"];

    // UI Strings
    const UIStrings = {
      pause:    { en: "Pause",  al: "Ndalo" },
      resume:   { en: "Resume", al: "Vazhdo" },
      stepWeek: { en: "Step (1 week)", al: "Hapi (1 javÃ«)" },
      faster:   { en: "Faster", al: "MÃ« shpejt" },
      slower:   { en: "Slower", al: "MÃ« ngadalÃ«" },
      dayLabel: { en: "Day",    al: "Dita" },
      springEq: { en: "Spring Equinox!",  al: "Ekuinoksi i PranverÃ«s!" },
      autumnEq: { en: "Autumn Equinox!",  al: "Ekuinoksi i VjeshtÃ«s!" }
    };

    function init(){
      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.1, 1000);
      camera.position.set(30,15,30);

      renderer = new THREE.WebGLRenderer({ antialias:true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.body.appendChild(renderer.domElement);

      controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.05;
      controls.target.set(0,0,0);
      controls.update();

      // Lights
      const sunLight = new THREE.PointLight(0xffffff,2,100);
      sunLight.position.set(0,0,0);
      scene.add(sunLight);

      const dirLight = new THREE.DirectionalLight(0xffffff,1.2);
      dirLight.position.set(10,20,10);
      scene.add(dirLight);

      const ambient = new THREE.AmbientLight(0xffffff,0.3);
      scene.add(ambient);

      // Sun
      const sunGeo = new THREE.SphereGeometry(2,32,32);
      const sunMat = new THREE.MeshBasicMaterial({ color:0xffaa00 });
      sunMesh = new THREE.Mesh(sunGeo, sunMat);
      scene.add(sunMesh);

      // Sun label (smaller)
      sunLabel = createTextSprite("Sun","#fff", 0.4);
      sunLabel.position.set(3,2,0);
      scene.add(sunLabel);

      // Earth group
      earthGroup = new THREE.Group();
      scene.add(earthGroup);

      // Earth sphere
      // Make Earth sphere with radius=1, add segments for smoother results
      const earthGeo = new THREE.SphereGeometry(1, 64, 64);

      // Just an ocean-blue color
      const earthMat = new THREE.MeshStandardMaterial({
        color: 0x1E90FF
      });

      const earthSphere = new THREE.Mesh(earthGeo, earthMat);
      earthGroup.add(earthSphere);

      // Equator ring
      const eqGeo = new THREE.RingGeometry(0.98,1.0,64);
      const eqMat = new THREE.LineBasicMaterial({ color:0xff0000 });
      equatorRing = new THREE.LineLoop(eqGeo, eqMat);
      equatorRing.rotation.x = Math.PI/2;
      earthGroup.add(equatorRing);

      // N-S axis
      const nsPoints = [new THREE.Vector3(0,1.2,0), new THREE.Vector3(0,-1.2,0)];
      const nsGeo = new THREE.BufferGeometry().setFromPoints(nsPoints);
      const nsMat = new THREE.LineBasicMaterial({ color:0xffffff });
      nsLine = new THREE.Line(nsGeo, nsMat);
      earthGroup.add(nsLine);

      // N & S label sprites
      nLabel = createTextSprite("N","#fff",0.5);
      sLabel = createTextSprite("S","#fff",0.5);
      nLabel.position.set(0,1.4,0);
      sLabel.position.set(0,-1.4,0);
      earthGroup.add(nLabel);
      earthGroup.add(sLabel);

      // Dashed sun ray
      const rayGeo = new THREE.BufferGeometry().setFromPoints([
        new THREE.Vector3(0,0,0), new THREE.Vector3(1,0,0)
      ]);
      const rayMat = new THREE.LineDashedMaterial({color:0xffff00, dashSize:0.5, gapSize:0.5});
      sunRay = new THREE.Line(rayGeo, rayMat);
      sunRay.computeLineDistances();
      scene.add(sunRay);

      // Draw the elliptical orbit as a line from multiple points
      drawEllipsePath();

      // UI Buttons
      document.getElementById('pauseResume').onclick = togglePause;
      document.getElementById('stepWeek').onclick = stepWeek;
      document.getElementById('increaseSpeed').onclick = ()=> speed*=1.2;
      document.getElementById('decreaseSpeed').onclick = ()=> speed/=1.2;
      document.getElementById('toggleLang').onclick = toggleLang;

      updateUIStrings();
      initTouchCommands();
    }

    // createTextSprite with adjustable scale
    function createTextSprite(txt, color="#fff", scale=0.8){
      const canvas = document.createElement('canvas');
      canvas.width=64; canvas.height=64;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle="#000";
      ctx.fillRect(0,0,64,64);
      ctx.fillStyle=color;
      ctx.font='48px Arial, sans-serif';
      ctx.textAlign='center';
      ctx.textBaseline='middle';
      ctx.fillText(txt,32,32);

      const tex = new THREE.CanvasTexture(canvas);
      const spriteMat = new THREE.SpriteMaterial({ map: tex });
      const sprite = new THREE.Sprite(spriteMat);
      sprite.scale.set(scale,scale,scale);
      return sprite;
    }

    function drawEllipsePath(){
      // We create a line by sampling param E from 0..2Ï€
      let ellipsePoints=[];
      let segments=200;
      const rNumer=a*(1-e*e); // ~14.994 for e=0.02, a=15
      for(let i=0; i<=segments; i++){
        let E = 2*Math.PI*(i/segments);
        let r = rNumer/(1 + e*Math.cos(E));
        let x = r*Math.cos(E);
        let z = r*Math.sin(E);
        ellipsePoints.push( new THREE.Vector3(x,0,z) );
      }
      const ellGeo = new THREE.BufferGeometry().setFromPoints(ellipsePoints);
      const ellMat = new THREE.LineBasicMaterial({color:0xffffff});
      ellipseLine = new THREE.LineLoop(ellGeo, ellMat);
      scene.add(ellipseLine);
    }

    function initTouchCommands(){
      let lastTapTime=0, tapTimeout=null;
      renderer.domElement.addEventListener('touchstart',(e)=>{
        const now=Date.now();
        if(now-lastTapTime<300){
          clearTimeout(tapTimeout);
          tapTimeout=null;
          lastTapTime=0;
          stepWeek();
        } else {
          lastTapTime=now;
          tapTimeout=setTimeout(()=>{
            tapTimeout=null;
            togglePause();
          },300);
        }
      },false);
    }

    function togglePause(){
      if(isEquinoxPause)return;
      isPaused=!isPaused;
      document.getElementById('pauseResume').textContent=
        isPaused? UIStrings.resume[currentLang] : UIStrings.pause[currentLang];
    }

    function stepWeek(){
      if(isPaused && !isEquinoxPause){
        day+=7;
        if(day>=365) day-=365;
        updateEarthPositionAndTilt(day);
      }
    }

    function toggleLang(){
      currentLang=(currentLang==='en')?'al':'en';
      updateUIStrings();
    }

    function updateUIStrings(){
      document.getElementById('pauseResume').textContent=
        isPaused? UIStrings.resume[currentLang]:UIStrings.pause[currentLang];
      document.getElementById('stepWeek').textContent=UIStrings.stepWeek[currentLang];
      document.getElementById('increaseSpeed').textContent=UIStrings.faster[currentLang];
      document.getElementById('decreaseSpeed').textContent=UIStrings.slower[currentLang];
      // Opposite flag
      const langBtn=document.getElementById('toggleLang');
      if(currentLang==='en'){
        langBtn.textContent='ðŸ‡¦ðŸ‡±';
      } else {
        langBtn.textContent='ðŸ‡¬ðŸ‡§';
      }
      updateDayDateCaption(day);
    }

    function animate(){
      requestAnimationFrame(animate);
      if(!isPaused && !isEquinoxPause){
        day+=speed;
        if(day>=365) day-=365;
      }
      updateEarthPositionAndTilt(day);
      checkEquinoxAutoPause(day);
      updateDayDateCaption(day);

      controls.update();
      renderer.render(scene,camera);
    }

    function updateEarthPositionAndTilt(d){
      // param E => day=172 => E=Ï€ => aphelion => a(1-e^2)/(1+ e cosE)
      const E = 2*Math.PI*((d-172)/365);
      const rNumer=a*(1-e*e);
      const rDenom=1+ e*Math.cos(E);
      const r=rNumer/rDenom;
      const ex=r*Math.cos(E);
      const ez=r*Math.sin(E);
      earthGroup.position.set(ex,0,ez);

      // reversed tilt sign => alpha= -maxTilt sin(...)
      const alpha=-maxTilt*Math.sin(2*Math.PI*((d-80)/365));

      const lenXZ=Math.sqrt(ex*ex + ez*ez)||1e-6;
      let Nx=0,Ny=0,Nz=0;
      if(lenXZ>1e-6){
        Nx=(ex/lenXZ)*Math.sin(alpha);
        Nz=(ez/lenXZ)*Math.sin(alpha);
      }
      Ny=Math.cos(alpha);

      const fromVec=new THREE.Vector3(0,1,0);
      const toVec=new THREE.Vector3(Nx,Ny,Nz).normalize();
      const quat=new THREE.Quaternion().setFromUnitVectors(fromVec,toVec);
      earthGroup.quaternion.copy(quat);

      // sunRay
      sunRay.geometry.setFromPoints([
        new THREE.Vector3(0,0,0),
        new THREE.Vector3(ex,0,ez)
      ]);
      sunRay.geometry.attributes.position.needsUpdate=true;
      sunRay.computeLineDistances();
    }

    function checkEquinoxAutoPause(d){
      const today=Math.floor(d);
      if(!isEquinoxPause && !isPaused){
        if((today===eqSpring||today===eqAutumn)&& today!==lastEquinoxTriggered){
          lastEquinoxTriggered=today;
          isEquinoxPause=true;
          isPaused=true;
          document.getElementById('pauseResume').textContent=UIStrings.resume[currentLang];
          const eqCap=document.getElementById('equinoxCaption');
          if(today===eqSpring){
            eqCap.textContent=UIStrings.springEq[currentLang];
          } else {
            eqCap.textContent=UIStrings.autumnEq[currentLang];
          }
          eqCap.style.display='block';
          setTimeout(()=>{
            eqCap.style.display='none';
            isEquinoxPause=false;
            isPaused=false;
            document.getElementById('pauseResume').textContent=UIStrings.pause[currentLang];
          },1500);
        }
      }
    }

    function updateDayDateCaption(d){
      const dayInt=Math.floor(d)+1;
      const dateString=dayToDateString(dayInt,currentLang);
      const label=(currentLang==='en')? UIStrings.dayLabel.en:UIStrings.dayLabel.al;
      document.getElementById('dayDateCaption').textContent=`${label} ${dayInt}: ${dateString}`;
    }

    function dayToDateString(dayNum,lang){
      let m=0,daysLeft=dayNum;
      while(m<12 && daysLeft>monthDays[m]){
        daysLeft-=monthDays[m];
        m++;
      }
      const monthName=(lang==='en')? monthNames_en[m]:monthNames_al[m];
      if(lang==='en'){
        return `${monthName} ${daysLeft}`;
      } else {
        return `${daysLeft} ${monthName}`;
      }
    }

    init();
    animate();

    window.addEventListener('resize',()=>{
      camera.aspect=window.innerWidth/window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth,window.innerHeight);
    });
  </script>
</body>
</html>
